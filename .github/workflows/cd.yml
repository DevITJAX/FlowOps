name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

# =============================================================================
# AZURE DEPLOYMENT CONFIGURATION
# =============================================================================
# To deploy this project to your own Azure account, you need to:
#
# 1. Create an Azure Container Registry (ACR):
#    - Go to Azure Portal > Create a Resource > Container Registry
#    - Note the registry name (e.g., myregistry.azurecr.io)
#
# 2. Create two Azure App Services (for backend and frontend):
#    - Backend: Configure as a container app pulling from your ACR
#    - Frontend: Configure as a container app pulling from your ACR
#
# 3. Configure the following GitHub Secrets in your repository:
#    - ACR_USERNAME: Your Azure Container Registry username (from ACR > Access keys)
#    - ACR_PASSWORD: Your Azure Container Registry password (from ACR > Access keys)
#    - AZURE_BACKEND_WEBHOOK: Backend App Service container webhook URL
#    - AZURE_FRONTEND_WEBHOOK: Frontend App Service container webhook URL
#
# 4. Update the environment variables below with your Azure resource names:
# =============================================================================

env:
  # TODO: Replace with your Azure Container Registry name
  ACR_NAME: <your-acr-name>.azurecr.io
  
  # TODO: Replace with your ACR image paths
  BACKEND_IMAGE: <your-acr-name>.azurecr.io/flowops-backend
  FRONTEND_IMAGE: <your-acr-name>.azurecr.io/flowops-frontend
  
  # TODO: Replace with your Azure App Service backend URL
  BACKEND_URL: https://<your-backend-app-name>.azurewebsites.net

jobs:
  build-and-deploy:
    name: Build and Deploy Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # Build and push Backend Docker image
      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
            ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build and push Frontend Docker image with API URL
      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
            ${{ env.FRONTEND_IMAGE }}:latest
          build-args: |
            VITE_API_URL=${{ env.BACKEND_URL }}/api
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Deploy Backend container to Azure App Service via Webhook
      - name: Deploy Backend to Azure
        run: curl -X POST "${{ secrets.AZURE_BACKEND_WEBHOOK }}"

      # Deploy Frontend container to Azure App Service via Webhook
      - name: Deploy Frontend to Azure
        run: curl -X POST "${{ secrets.AZURE_FRONTEND_WEBHOOK }}"
